<source>
  @type syslog
  port 514
  bind 0.0.0.0
  tag syslog
  include_source_host true
  format none
</source>
<source>
  @type beats
  port 5044
  metadata_as_tag 
</source>
<source>
  type forward
  port 24224
  bind 0.0.0.0
</source>
<match {syslog.**,*beat,docker.**}>
  @type record_reformer
  tag add_datetime.${tag_prefix[-1]}
  enable_ruby true
  server_received ${Time.now}
</match>
<filter add_datetime.syslog.**>
  @type parser
  key_name message
  reserve_data yes
  format /^.+s_sn="(?<message_id>.+)" s_id="(?<device_name>.+):(?<device_port>\d+)"\]: \d+: (?<log_date>.*): %(?<msg_type>(\w|-)+): (?<message>.*)$/
</filter>
<match add_datetime.syslog.*.emerg.*>
  type rewrite_tag_filter
  rewriterule1 message .+ type.emerg.unmatched
</match>
<match add_datetime.syslog.*.alert.*>
  type rewrite_tag_filter
  rewriterule1 message .+ type.alert.unmatched
</match>
<match add_datetime.syslog.*.crit.*>
  type rewrite_tag_filter
  rewriterule1 message ^.*Security.*address.*0000\.0000\.0000.*$ type.crit.noalert
  rewriterule2 msg_type ^.*PORT_SECURITY-2-PSECURE_VIOLATION.*$ type.crit.portsecurity
  rewriterule3 message .+ type.crit.unmatched
</match>
<match add_datetime.syslog.*.err.*>
  type rewrite_tag_filter
  rewriterule1 msg_type ^.*%LINK-3-UPDOWN.*$ type.err.noalert
  rewriterule2 message .+ type.err.unmatched
</match>
<match add_datetime.syslog.*.warn.*>
  type rewrite_tag_filter
  rewriterule1 message ^.*ARP.*0000\.0000\.0000.*$ type.warn.noalert
  rewriterule2 message .+ type.warn.unmatched
</match>
<match add_datetime.syslog.*.notice.*>
  type rewrite_tag_filter
  rewriterule1 msg_type ^.*SYS-5-CONFIG_I.*$ type.notice.configchg
  rewriterule2 message ^.*EIGRP.*$ type.notice.eigrp
  rewriterule3 msg_type ^.*EIGRP.*$ type.notice.eigrp
  rewriterule4 msg_type ^.*SYS-5-RELOAD.*$ type.notice.reload
  rewriterule5 msg_type ^.*C4K_HWACLMAN-4.*$ type.notice.hwacl
  rewriterule6 msg_type ^.*EC-5-BUNDLE.*$ type.notice.portchannel
  rewriterule7 message .+ type.notice.noalert
</match>
<match {*beat,docker}.**>
  @type copy
  <store>
    @type elasticsearch_dynamic
    host elasticsearch
    port 9200
    logstash_format true
    logstash_prefix ${tag_parts[0]}
    type_name ${record['type']}
    flush_interval 10s
  </store>
  <store>
    @type file
    path /data_log/logs/dynamic
    time_slice_format %Y%m%d
    time_slice_wait 10m
    time_format %Y%m%dT%H%M%S%z
    compress gzip
    utc 
    buffer_path /data_log/logs/dynamic.*
  </store>
</match>
<match **>
  @type copy
  <store>
    @type file
    path /data_log/logs/syslog
    time_slice_format %Y%m%d
    time_slice_wait 10m
    time_format %Y%m%dT%H%M%S%z
    compress gzip
    utc 
    buffer_path /data_log/logs/syslog.*
  </store>
  <store>
    @type elasticsearch
    host elasticsearch
    port 9200
    logstash_format true
    logstash_prefix logstash
    logstash_dateformat %Y.%m.%d
    utc_index true
    buffer_type memory
    flush_interval 60
    retry_limit 17
    retry_wait 1.0
    num_threads 1
  </store>
</match>

